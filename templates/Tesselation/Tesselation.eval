{% extends "base.glsl" %}

{% block header %}
//layout(triangles, equal_spacing, cw) in;
layout(triangles, fractional_even_spacing, ccw) in;
in vec3 tcPosition[];
in vec2 tcUv[];
out vec3 tePosition;
out vec2 teUv;
out vec3 tePatchDistance;
uniform mat4 MVPMatrix;
uniform sampler2D noise;
{% endblock %}

{% block main %}
    vec3 p0 = gl_TessCoord.x * tcPosition[0];
    vec3 p1 = gl_TessCoord.y * tcPosition[1];
    vec3 p2 = gl_TessCoord.z * tcPosition[2];
    tePatchDistance = gl_TessCoord;
    //tePosition = p0 + p1 + p2;
    
    vec2 u0 = gl_TessCoord.x * tcUv[0];
    vec2 u1 = gl_TessCoord.y * tcUv[1];
    vec2 u2 = gl_TessCoord.z * tcUv[2];
    teUv = u0 + u1 + u2;

	vec4 height = (texture(noise, teUv)+texture(noise, teUv*3)+texture(noise, teUv*4))/4;

	vec3 normalizedPosition = normalize(p0 + p1 + p2);
    tePosition = mix(normalizedPosition * height.x, normalizedPosition, 0.8);
    
    gl_Position = MVPMatrix * vec4(tePosition, 1);
{% endblock %}
